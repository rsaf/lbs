/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */



$(document).ready(function () {

    //Account Balance Form
    $("#accountBalanceForm").submit(function (event) {
        event.preventDefault();
        var data = JSON.stringify($(this).serialize());
        var msg = {pl: {
                accountId: $('#accountIdBalance').val(),
                accountType: $('#accountTypeBalance').val()
            }, er: null};

        var url = '/fmm_interface/verifyUserBalance';
        var html = "";

        $.post(url, msg, function (response) {
            if (response.pl.length > 0) {
                response=response.pl[0];
                html += '<h3>Account Balance</h3><br/>';
                html += "Current Amount: " + response.accountBalance + " RMB<br/>";
                html += "Last Updated: " + response.updatedAt + "<br/>";
            }
            else {
                html += 'No account found!';
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#accountBalanceResult').html(html);
        });
    });

    //Create account Form
    $('#createAccountForm').submit(function (event) {
        event.preventDefault();
        var data = $('#createAccountForm').serialize();
        var msg = {pl: {accountId: null, accountType: '', accountBalance: null}, er: null};
        msg.pl.accountId = $('#accountIdCreate').val();
        msg.pl.accountType = $('#accountType').val();
        msg.pl.accountBalance = $('#accountBalance').val();
        var url = '/fmm_interface/createAccount';
        var html = "";
        $.post(url, msg, function (response) {
            html += '<h3>New Account<\h3>';
            if (response.er == null) {
                html += "Account Id:" + response.pl.accountId + "<br/>";
                html += "Current Amount:" + response.pl.accountBalance + " RMB<br/>";
                html += "Created on:" + response.pl.createdAt + "<br/>";
            }
            else {
                html += 'Error: ' + response.er;
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#createAccountResult').html(html);
        });
    });
    
    //Create Order Form
    $('#createOrderForm').submit(function(event){
        event.preventDefault();
        var msg = {pl:{
                serviceType:$('#serviceTypeCreate').val(),
                serviceName:$('#serviceNameOrder').val(),
                serviceId:$('#serviceIdOrder').val(),
                userAccountId:$('#accountIdOrder').val(),
                serviceProviderId:$('#serviceProviderIdOrder').val(),
                corporationId:$('#corporationIdOrder').val(),
                platformCommissionAmount:$('#platformCommissionOrder').val(),
                agentCommissionAmount:$('#agentCommissionOrder').val(),
                agentId:$('#agentIdOrder').val(),
                orderAmount:$('#orderAmountOrder').val(),
                transactionId:$('#transactionIdOrder').val(),
                paymentType:$('#paymentTypeCreate').val()
                
        } 
                    , er:null}
         var url = '/fmm_interface/createOrder';
        var html = "";        
        $.post(url, msg,function(response){
            if(response){
                html += 'Create Order<br/>';
                html += "---------------<br/>";
                if (response.er == null) {
                    html += "New Order Id:"+response.pl.id;
                }
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#createOrderResult').html(html);
        });
    });

    //Transfer credits form
    $('#transferCreditForm').submit(function (event) {
        event.preventDefault();
        var msg = {pl: {sourceAccountId: '', destinationAccountId: '', transactionAmount: '', paymentOrderId: ''}, er: null};
        msg.pl.sourceAccountId = $('#sourceAccountIdTransfer').val();
        msg.pl.destinationAccountId = $('#destinationAccountIdTransfer').val();
        msg.pl.transactionAmount = $('#transactionAmountTransfer').val();
        msg.pl.paymentOrderId = $('#paymentOrderIdTransfer').val();
        var url = '/fmm_interface/recordPayment';
        var html = "";
        $.post(url, msg, function (response) {
            html += 'Transfer Status<br/>';
            html += "---------------<br/>";
            if (response.er == null) {
                html += "Source Account Id:" + response.pl.destinationAccountId + "<br/>";
                html += "Destination Account Id:" + response.pl.sourceAccountId + " RMB<br/>";
                html += "Amount Transfered:" + response.pl.transactionAmount + "<br/>";
            }
            else {
                html += 'Error: ' + response.er;
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#transferCreditResult').html(html);
        });
    });

    //Account History form
    $('#transactionHistoryForm').submit(function (event) {
        event.preventDefault();
        var msg = {pl: {accountId: ''}, er: null};
        msg.pl.accountId = $('#accountIdHistory').val();
        var url = '/fmm_interface/getTransactionHistory';
        var html = "";
        $.post(url, msg, function (response) {
            
            if (response.pl.length>0) {
                html += '<h3>Transfer History</h3><br/>';
                 html+="<table width='100%'>";
                html+="<tr><td>Source Account</td><td>Destination Account</td><td>Amount</td><td>Balance</td></tr>";
                
                $.each(response.pl, function (index, value) {
                    html += '<tr><td>'+value.sourceAccountId+'</td><td>'+value.destinationAccountId+'</td><td>'+value.transactionAmount+' </td><td>'+value.accountBalance+' </td></tr>';
                  
                });
                html+="<table width='100%'>";
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#transactionHistoryResult').html(html);
        });
    });

    //Transfer credits form
    $('#checkAlipayTransactionForm').submit(function (event) {
        event.preventDefault();
        var msg = {pl: {outTradeNumber: '', accountId: '', transactionAmount: ''}, er: null};
        msg.pl.outTradeNumber = $('#outTradeNumberAlipayTransaction').val();
        msg.pl.accountId = $('#accountIdAlipayTransaction').val();
        msg.pl.transactionAmount = $('#transactionAmountAlipayTransaction').val();

        var url = '/fmm_interface/verifyPayment';
        var html = "";
        $.post(url, msg, function (response) {
            html += 'Transfer Status\n';
            html += "---------------\n";
            if (response.er == null) {
                html += "Source Account Id:" + response.pl.destinationAccountId + "\n";
                html += "Destination Account Id:" + response.pl.sourceAccountId + " RMB\n";
                html += "Amount Transfered:" + response.pl.transactionAmount + "\n";
            }
            else {
                html += 'Error: ' + response.er;
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#checkAlipayTransactionResult').html(html);
        });
    });
    
    //Change Order Status
    $('#changeOrderStatusForm').submit(function(event){
        event.preventDefault();
        if(!$('#transactionIdChangeOderStatus').val()){
            alert('Please enter a transaction ID');
            return false;
        }
        var msg = {pl: {transactionId: '',orderStatus:''}, er: null};
        msg.pl.transactionId = $('#transactionIdChangeOderStatus').val();
        msg.pl.orderStatus = $('#orderStatusChangeOrderStatus').val();
        var url = '/fmm_interface/changeOrderStatus';
        var html = "";
        
        $.post(url,msg,function(response){
            html += '<h3>Order Status</h3><br/>';
            if (response.pl !== null) {
                html += response.pl.orderStatus;
            }
            else {
                html += 'Error: ' + response.er;
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#changeAccountStatusResult').html(html);
        });
    });

    //Transfer credits form
    $('#splitPaymentForm').submit(function (event) {
        event.preventDefault();
        var msg = {pl: {transactionId: ''}, er: null};
        msg.pl.transactionId = $('#splitPaymentTransactionId').val();
       
        var url = '/fmm_interface/splitPayment';
        var html = "";
        $.post(url, msg, function (response) {
            html += 'Transfer Status<br/>';
            html += "---------------<br/>";
            if (response.er === null) {
                html = response;
            }
            else {
                html += 'Error: ' + response.er;
            }
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function () {
            $('#splitPaymentResult').html(html);
        });
    });
    
    //Sell Credits
    $('#sellCreditsForm').submit(function(event){
        event.preventDefault();
        var msg = {pl:{accountId:'',orderAmount:'',serviceId:'',transactionId:''}};
        msg.pl.accountId = $('#sellCreditsAccountId').val();
        msg.pl.orderAmount = $('#sellCreditsAmount').val();
        msg.pl.serviceId = $('#sellCreditsServiceId').val();
        msg.pl.transactionId=$('#sellCreditsTransactionId').val();
        
        if($.trim(msg.pl.accountId)==="" || $.trim(msg.pl.serviceId) ==='' || $.trim(msg.pl.orderAmount)===''){
            alert('Please fill out the entire form!');
            return false;
        }
         var url = '/fmm_interface/sellCredits';
        var html = '';
        $.post(url,msg,function(response){
            html += 'Sale Status<br/>';
            html += "---------------<br/>";
            if (response.er === null) {
                html = response;
            }
            else {
                html += 'Error: ' + response.er;
            }
        })
        .fail(function(error){
            html = 'Error: '+error;
        })
        .done(function(html){
            $('#sellCreditsResult').html(html);
        });
    });
    
    //Alipay submit form
    $("#aliPaySubmitForm").submit(function (event) {
        event.preventDefault();

        var msg = {pl: {orders: [{}], transactionId: '', subject: '', transactionAmount: ''}, er: null};
        msg.pl.transactionId = $('#outTradeNumberAlipayPayment').val();
        msg.pl.subject = $('#subjectAlipayPayment').val();
        msg.pl.transactionAmount = $('#transactionAmountAlipayPayment').val();

        if (msg.pl.transactionAmount == '' || msg.pl.transactionId == '' || msg.pl.subject == '') {
            alert('Please fill out the form!');
            return false;
        }
        msg.pl.orders = [
            {
                userAccountId: 'F00005',
                transactionId: msg.pl.transactionId,
                serviceId: "S00001",
                serviceName: 'ALIPAY_CREDIT',
                serviceType: 'CREDIT_PURCHASE',
                serviceProviderId: "F00001",
                corporationId: "F00001",
                orderAmount: 350,
                platformCommissionAmount: 0
            },
            {
                serviceId: "S00002",
                serviceProviderId: "SP0001",
                transactionId: msg.pl.transactionId,
                serviceName: 'FRONTEND_SERVICE_1',
                serviceType: 'ACTIVITY',
                orderAmount: 150,
                platformCommissionAmount: 10,
                corporationId: "F00004",
               userAccountId: 'F00005'
            },
            {
                serviceId: "S00003",
                serviceProviderId: "SP0002",
                transactionId: msg.pl.transactionId,
                orderAmount: 200,
                serviceName: 'FRONTEND_SERVICE_2',
                serviceType: 'ACTIVITY',
                platformCommissionAmount: 0,
                corporationId: "F00004",
                userAccountId: 'F00005'
            }];

        var url = '/fmm_interface/makeAliPayment';
        var html = '';
        $.post(url, msg, function (response) {
            window.open(response.pl.url, '_blank');
        }).fail(function (error) {
            html = 'Error:' + error;
        }).done(function (html) {
            $('#checkAlipayTransactionResult').html(html);
            html='<h3>Your Purchase<h3>';
            html+='-------------------------------';
            $.each( msg.pl.orders, function( index, value ){
                html += "<h5>Service"+(index+1)+"<h5>"
                html += "Name:" + value.serviceName + "<br/>";
                html += "Code:" + value.serviceId + "<br/>";
                html += "Provider:" + value.serviceProviderId + "<br/>";
                html += "Transaction ID:" + value.transactionId + "<br/>";
                html += "Amount:" + value.orderAmount + "<br/>";
            });
           
            $('.modal-body').html(html);
            $('#paymentModal').modal('show');        
        });
        
    });
    
    //Confirm Sell Credits
    $("#confirmSellCreditsForm").submit(function(event){
        event.preventDefault();
        var url = '/fmm_interface/getCreditSales';
        var html = '';
        var msg = null;
        $.post(url,msg,function(response){       
                html+="<table width='100%'>";
                html+="<tr><td>Corporation</td><td>Amount</td><td>Action</td></tr>";
            $.each(response.pl,function(index, value){
                html+="<tr><td>"+value.userAccountId+"</td><td>"+value.orderAmount+" RMB</td><td id='"+value.id+"' ><button class='confirmCreditSaleButton btn btn-default' data-container='"+value.id+"'>Confirm</button></td></tr>";
            });
           html+="</table>";
           
        })
        .fail(function(error){
            html = 'Error: '+error;
        })
        .done(function(){
            //$('#confirmSellCreditsResult').html(html);
            $('#confirmSellCreditsResult').html(html);
        });
    });
    
    //ConfirmationButton Credit Sale
    $('body').on('click', '.confirmCreditSaleButton', function() {
        var button = $(this);
        var orderId = $(this).attr('data-container');
        var msg ={pl:{orderId:orderId},er:null};
        var url = '/fmm_interface/confirmCreditSales';
        var html ='';
        $.post(url,msg,function(){
            button.html("Processing...");
        })
        .fail(function(error){
            html = 'Error: '+error;
        })
        .done(function(){
            //$('#confirmSellCreditsResult').html(html);
            button.addClass('btn-success');
            button.html("Done!");
            button.prop("disabled",true);
        });
    });
    
    //Confirmation Button for Alipay
    $('#confirmPaymentAlipayButton').click(function(event){
        var msg = {pl:{transactionId:'', notifyId:'7978789789' , transactionAmount:'' , accountId:''},er:null};
        msg.pl.transactionId = $('#outTradeNumberAlipayPayment').val();
        msg.pl.accountId = $('#accountIdAlipayPayment').val();
        msg.pl.transactionAmount = $('#transactionAmountAlipayPayment').val();
        
        var url = '/fmm_interface/alipayNotify';
        var html = '';
        $.post(url, msg, function(response){
            console.log(response);
        })
        .fail(function(error){

        })  
        .done(function(){
             //Socket IO
            var socket = io.connect('http://localhost:9090');          
            socket.emit('alipayRequest', msg);
            socket.on('alipayResponse', function (data) {
                console.log('RCV:', data);
                if (data.pl.is_success && data.pl.trade_status === "TRADE_FINISHED") {
                    $('#paymentModal.modal-body').html('Your Payment has been processed successfully!');
                }
                else {
                    $('#paymentModal.modal-body').html('We could not verify your payment');
                }

            });
        });
    });
    
    //DropDown menu event
    $('#serviceTypeCreate').change(function(event){
        
        var currValue = $(this).val();
        
        if(currValue ==='ACTIVITY'){
            $('#serviceNameOrder').attr('disabled',false);
        } 
        else{
            $('#serviceNameOrder').attr('disabled',true);
        }
    });
    
});

    