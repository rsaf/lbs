/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

//var oCMM = require('cmm');
var oFMM = require('../fmm_Interface.js');
function message(m) {
    if (m.op === 'dependency')
    {
        m.ns = 'fmm';
        //return oCMM.dependency(m);
    }
}
var init_message = {
    'op': 'init',
    ns: '',
    'pl': {fn: message}
};
var corporationId = 500;
var clientId = 445;
var systemId = 1000;
var alipayId = 888;
var paymentAmount = 100;
var transactionId = Math.floor(Math.random() * 1000).toString();
var paymentOrderId=null;
//Alipay
var notifyId = 000;
var ms = {ns: null, pl: null, er: null};
exports.start = function (test) {
    test.expect(15);
 
                //Step2:Create corporation account
                ms.pl = {accountId: corporationId, accountBalance: 0, accountType: 'corporation'};
                return oFMM.createAccount(ms).then(function (r) {                 
                    test.equals(r.er, null);
                    test.equals(r.pl.accountId, ms.pl.accountId);
                    test.equals(r.pl.accountBalance, ms.pl.accountBalance);
                    test.equals(r.pl.accountType, ms.pl.accountType);
                    console.log('Corporation Account Created:', r + "\n");
                })
            .then(function () {
                //Step3:Create client account
                ms.pl = {accountId: clientId, accountBalance: 0, accountType: 'personal'};
                return oFMM.createAccount(ms).then(function (r) {                
                    test.equals(r.er, null);
                    test.equals(r.pl.accountId, ms.pl.accountId);
                    test.equals(r.pl.accountBalance, ms.pl.accountBalance);
                    test.equals(r.pl.accountType, ms.pl.accountType);
                    console.log('Client Account Created:', r + "\n");
                });
            })
            .then(function () {
                //Step4:Generate Alipay URL
                ms.pl = {out_trade_no: transactionId, totalAmount: 100, subject: 'Test Transaction'};
                ms.pl.orders = [{userLogin: 'testUser',
                        transactionId: transactionId,
                        serviceId: 1,
                        serviceName:'ALIPAY_CREDIT',
                        serviceType:'CREDIT_PURCHASE',
                        serviceProviderId: systemId,
                        corporationId: systemId,
                        orderAmount: 100,
                        platformCommissionAmount: 0},
                    {userLogin: 'testUser',
                        transactionId: transactionId,
                        serviceId: 2,
                        serviceName:'SERVICE 2',
                        serviceProviderId: 2,
                        corporationId: corporationId,
                        affiliateCommissionAmount:0,
                        orderAmount: 50,
                        affiliateId: clientId,
                        platformCommissionAmount: 5},
                     {userLogin: 'testUser',
                        transactionId: transactionId,
                        serviceId: 3,
                        serviceName:'SERVICE 3',
                        serviceProviderId: 3,
                        corporationId: corporationId,
                        affiliateCommissionAmount: 0,
                        orderAmount: 50,
                        affiliateId: clientId,
                        platformCommissionAmount: 10}
                ];
                return oFMM.generateAlipayUrl(ms)
                        .then(function (r) {
                            paymentOrderId = r.pl.paymentOrderId;
                            console.log('\nAlipay URL Generated:', r.pl.url);
                            test.equals(r.er, null);
                        });
            })
            .then(function () {
                //Step5:Verify Payment with Alipay
                ms.pl = {
                    
                    accountId: clientId,//System Account Id
                    transactionAmount: paymentAmount,
                    transactionId: transactionId
                };
                return oFMM.alipayNotification(ms).then(function (r) {                  
                    test.equals(r.er, null);
                    console.log('\nAlipay Notification PASSED:', r);
                });
            })
          
            .then(function(){
                //Step6: Update order status
                ms.pl = {orderStatus: 'split', where:{transactionId: transactionId,serviceType:'ACTIVITY'}};
                return oFMM.updateOrderStatus(ms).then(function (r) {
                    console.log('\nUpdated order Status:', r);
                    test.equals(r.er, null);
                });
            })
            .then(function () {
                //Step7: Split Payment at last...
                ms.pl = {transactionId: transactionId};
                return oFMM.splitPayment(ms).then(function (r) {       
                    console.log('result',r);
                    test.equals(r.er, null);
                    console.log('\nTransaction Split Payment:', r);
                });
            })
            .then(function () {
                //Step8: Get all transaction history
                ms.pl = {};
                return oFMM.getTransactionHistory(ms).then(function (r) {
                    test.equals(r.er, null);
                    
                });
            }) 
            .then(function () {
                //Step9:Verify user balance
                ms.pl = {accountId: systemId};
                return oFMM.verifyUserBalance(ms).then(function (r) {
                    test.equals(r.er, null);
                    test.equals(r.pl.accountId, systemId);
                    test.done();
                    console.log('\nBalance for System', r);
                });
            })
            .fail(function (error) {
                console.log(error);
                test.done();
            });

};
exports.tearDown = function (callback) {
    console.log("\ntearing down integration testing ...");
    callback();
};
//Setup API Tests: begin...
exports.setUp = function (callback) {
    console.log('\nsetting up integration testing ....');
    oFMM.init(init_message).then(function (r) {
        console.log('SUCESS:', r);
        callback();
    }).fail(function (r) {
        console.log(r);
        callback();
    });
}
;



