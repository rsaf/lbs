From b2b0d00097edbeab45de6a26c3e01879ef66a445 Mon Sep 17 00:00:00 2001
From: rolland <rolland@lbsconsulting.com.cn>
Date: Mon, 13 Jul 2015 15:32:43 +0800
Subject: [PATCH] pushing for testing

---
 fmm_Interface.js | 24 +++++++++++++++++++-----
 1 file changed, 19 insertions(+), 5 deletions(-)

diff --git a/fmm_Interface.js b/fmm_Interface.js
index 39fa607..363e98a 100755
--- a/fmm_Interface.js
+++ b/fmm_Interface.js
@@ -130,8 +130,7 @@ function init(m) {
                 var p3 = accountBalance.findOrCreate({
                     where: {accountId: platformCommissionAccountId},
                     defaults: {accountType: "admin"}
-                })
-                    .spread(function (user, created) {
+                }).spread(function (user, created) {
                         if (created) {
                             return transactionHistory.findOrCreate(
                                 {
@@ -1231,6 +1230,21 @@ function fmm_generateWechatPayUrl(m) {
     });
     q.all(promises)
         .then(function (order) {
+
+          return  getwxOpenID(data.code).then(function(r){
+
+              console.log('r open id----',r);
+
+               return r;
+            });
+
+
+        })
+        .then(function(openId){
+
+
+            console.log('openId----',openId)
+
             var sum = data.orders.reduce(function(sum, ele){return sum + ele.orderAmount},0);
             //Get the request parameters for Alipay form
             //get open id needed..
@@ -1241,7 +1255,7 @@ function fmm_generateWechatPayUrl(m) {
                 out_trade_no: data.orders[0].transactionId + "T" + parseInt(new Date() / 1000, 10),//data.out_trade_no,
                 total_fee: sum,
                 spbill_create_ip: "127.0.0.1",
-                openid: "ofgxpuEA11o7f121X8PHq3eO7WkM",
+                openid: openId,
                 trade_type: 'JSAPI'
             };
             var prom = q.defer();
@@ -1251,7 +1265,6 @@ function fmm_generateWechatPayUrl(m) {
                 if(err){
                     prom.reject(err);
                 }
-
                 //@ToDo check when payargs is empty
                 else {
                     prom.resolve(payargs);
@@ -1259,8 +1272,9 @@ function fmm_generateWechatPayUrl(m) {
 
             });
             return prom.promise;
-        })
 
+
+        })
         .then(function (paymentArgument) {
             r.pl = paymentArgument;
             deferred.resolve(r);
-- 
2.3.2 (Apple Git-55)

