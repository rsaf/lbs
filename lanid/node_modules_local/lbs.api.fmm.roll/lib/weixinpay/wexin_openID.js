/**
 * Created by leo on 7/8/15.
 */
$(function () {
    var wxopenid=getcookie('wxopenid');
    var key=getcookie('key');
    if (key==''){
        var access_code=GetQueryString('code');
        if (wxopenid==""){
            if (access_code==null)
            {
                var fromurl=location.href;
                var url='https://open.weixin.qq.com/connect/oauth2/authorize?appid=填你自已的appid哟&redirect_uri='+encodeURIComponent(fromurl)+'&response_type=code&scope=snsapi_base&state=STATE%23wechat_redirect&connect_redirect=1#wechat_redirect';
                location.href=url;
            }
            else
            {
                $.ajax({
                    type:'get',
                    url:ApiUrl+'/index.php?act=payment&op=getopenid',
                    async:false,
                    cache:false,
                    data:{code:access_code},
                    dataType:'json',
                    success:function(result){
                        if (result!=null && result.hasOwnProperty('openid') && result.openid!=""){
                            addcookie('wxopenid',result.openid,360000);
                            getlogininfo(result.openid);
                        }
                        else
                        {
                            alert('微信身份识别失败 \n '+result);
                            location.href=fromurl;
                        }
                    }
                });
            }
        }else{
            if (key=='' && wxopenid!='')
                getlogininfo(wxopenid);
        }

        function getlogininfo(wxopenid){
            $.ajax({
                type:'get',
                url: ApiUrl + '/index.php?act=login&op=autologininfo',
                data: { wxopenid:wxopenid},
                dataType:'json',
                async:false,
                cache:false,
                success: function (result) {
                    if (result.return_code=='OK'){
                        addcookie('key',result.memberinfo.key);
                        addcookie('username',result.memberinfo.username);
                    }else{
                        alert(result.return_msg);
                        location.href=WapSiteUrl+'/tmpl/member/login.html';
                    }
                }
            });
        }
    }

    //working sample test appid
    //https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxcc9ddceda48cd1dc&redirect_uri=http%3A%2F%2Fwechat.ccmeiche.com&response_type=code&scope=snsapi_base&state=77
    //https://api.weixin.qq.com/sns/oauth2/access_token?appid=wxcc9ddceda48cd1dc&secret=QWWEasdaaQW2EQWE1231234KOIJJD487&code=0116d70a2f2081f5e06f8c03ca67c18T&grant_type=authorization_code

    //https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7c91e365ed94128f&redirect_uri=http%3A%2F%2Fdev.www.idlan.cn&response_type=code&scope=snsapi_base&state=77#wechat_redirect
    //https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx7c91e365ed94128f&secret=8f92b6ad5083d8b4d316c45e723b0223&code=0116d70a2f2081f5e06f8c03ca67c18T&grant_type=authorization_code


    //http://wechat.ccmeiche.com/?code=0116d70a2f2081f5e06f8c03ca67c18T&state=77

    //reduce test string
    //https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx520c15f417810387&redirect_uri=http%3A%2F%2Fchong.qq.com&response_type=code&scope=snsapi_base&state=77
    //

    //https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx520c15f417810387&redirect_uri=http%3A%2F%2Fchong.qq.com%2Fphp%2Findex.php%3Fd%3D%26c%3DwxAdapter%26m%3DmobileDeal%26showwxpaytitle%3D1%26vb2ctag%3D4_2030_5_1194_60&response_type=code&scope=snsapi_base&state=123#wechat_redirect
});