/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

var oMDM = require('../mdm_Interface.js');
var oCMM = require('cmm');


function message(m){
    if (m.op === 'dependency')
    {
        m.ns = 'mdm';

        return oCMM.dependency(m);
    }
    if (m.op === 'instantiate'){
        return oMDM.instantiate(m);
    }
}
var init_message = {
    'op': 'init',
    ns : '',
    'pl':{fn:message}
};

exports.testSendNotification = function(test) {
    var m = {
    ns: 'mdm',
    vs: '1.0',
    op: 'sendNotification',
    pl: {
         recipients:[{
             inmail:{to:'leo'},
             weixin:{to:'lionleo001'},
             sms:{to:'15900755434'},
             email:{to:'leo@lbsconsulting.com.cn'}
         }],
         notification:{
         subject:'事务提交成功',
         body:'事务提交成功事务提交成功事务提交成功事务提交成功事务提交成功事务提交成功事务提交成功',
         notificationType:'业务通知'}
    }};

    oMDM.sendNotification(m)
    .then(function(r) {
        //console.log("Send Mail Response:  " );
        //console.log(r);
        test.expect(2);
        test.equals(r.er.em, null);
        test.equals(r.pl.notification.subject, m.pl.notification.subject);
        test.done();
    })
    .fail(function(r){
      console.log("send mail fail: .." + r);
      test.done();
    });
};
//
//exports.testGetNotificationByTo = function(test) {
//    var m = {
//    ns: 'mdm',
//    vs: '1.0',
//    op: 'getNotificationByTo',
//    pl: {
//         viewStatus: true, // null
//         to:'leo',
//         pageNumber: 1,
//         pageSize: 10
//    }
//};
//    oMDM.getNotificationByTo(m)
//        .then(function(r) {
//            //console.log("Readmail response  ");
//            //console.log(r);
//            if(r.pl.length>0) {
//                test.expect(2);
//                test.equals(r.er.em, null);
//                test.equals(r.pl[0].recipient.inmail.to, m.pl.to);
//            }
//            test.done();
//        })
//        .fail(function(r){
//            console.log("read mail fail: .." + r);
//            test.done();
//        });
//};
//
//exports.testUpdateViewStatus = function(test) {
//    var m = {
//        ns: 'mdm',
//        vs: '1.0',
//        op: 'updateViewStatus',
//        pl: {
//            messageID:'54ca9449c460f8ffb073f51e',
//            viewStatus: true
//        }
//    };
//    oMDM.updateViewStatus(m)
//        .then(function(r) {
//                 //console.log("Readmail response  ");
//                //console.log(r);
//                test.expect(2);
//                test.equals(r.er.em, null);
//                test.equals(r.pl._id, m.pl.messageID);
//                test.done();
//        })
//        .fail(function(r){
//            console.log("read mail fail: .." + r);
//            test.done();
//        });
//};
//
exports.setUp = function setUp(callback) {
    console.log('\nsetting up integration testing ....');
    oCMM.init(init_message).then(function (r){
        oMDM.init(init_message).then(function (r1) {
            console.log(r1);
            callback();
        }).fail(function (r) {
            console.log(r);
        });
    });
};

exports.tearDown = function tearDown(callback) {
    console.log("\ntearing down integration testing ...");
    callback();
};
