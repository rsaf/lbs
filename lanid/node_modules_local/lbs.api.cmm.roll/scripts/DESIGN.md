# Image File server

## Goal: Store, process and serve images and their properties

Store and retrieve images and their related properties (as JSON document) through the web. Track images derivatives using UUID (Universal Unique IDentifier) to identify the source and bucket the data across image servers that can serve images using nginx through the frontend nginx.

## Image upload

* Frontend nginx receives POST and pushes to the application server
 * NodeJS receives image data POST + properties document
 * PMM call on the ESB bus
  * PMM (Photo Management Module) gets the data
  * Generates UUID (v4, random)
  * Extract image properties from image data
  * Verify extracted image properties versus declared properties (and images file size, pixels, etc)
  * Store properties document with generated UUID to database with state=PROCESSING
  * Figure out which bucket/server to upload to from the UUID (originally one server, so function returns kindi)
  * Insert EXIF information into image
  * scp image on right server for processing (using promise)
   * create directory structure mkdir -p from UUID broken down into parts
   * write data to the right directory
   * run ImageMagick transformations
   * exit 0 if successful, exit 1 otherwise
  * transfer completed, promises and database state of the image is set to COMPLETED
* POST transaction returns to the client

## Image retrieval

* Frontend nginx retrieves request
* Figures out bucket/server from UUID
* Serves images from individual image server nginx

## Image re-bucketing

* Frontend NGINX is configured to support both old and new bucket layout
* Jobs on each image server are started to rsync image folders on the right server
* Update nginx rules to get rid of the old bucket layout
* Once rsync'ed images from the old bucket can be deleted

## Caching

* Image caching on the frontend nginx

## Image reprocessing

* upload script and transformation script are splitted
* ??? track type of photos ???
* find all files
 * reapply transformation script

## TODO

create the PMM proof of concept (DONE)
* add actual image data to the payload call of uploadPhoto
* various validation and copy step
* do the promise to the ssh server

configure the image server

* uploadbot account (with authorized_keys)
* generate one on duma (spider account)
* nginx
* shell script
* ssh account integration

directory structure layout (internally decided)

configure the frontend

UUID to bucket logic

Testing examples
cat /Users/LBS006/Desktop/passportPhoto_ID.jpg  | ssh uploadbot@localhost "uploadphoto fd81098a-535f-4cea-aa8a-7647ffc04940 jpg https://www.idlan.cn"
ssh uploadbot@localhost "qrcode fd81098a-535f-4cea-aa8a-7647ffc04940 jpg https://www.idlan.cn"
cat DESIGN.md | ssh uploadbot@localhost "uploadfile fd81098a-535f-4cea-aa8a-7647ffc04940 md https://www.idlan.cn"
cat /Users/LBS006/dev/bitbucket/lbs.lanid.web.leo/static/index.html  | ssh uploadbot@localhost "uploadform fd81098a-535f-4cea-aa8a-7647ffc04940 html https://www.idlan.cn"
