#!/bin/bash

# generate the directory names from UUID
ONE=$( echo "$FILE_UUID" | cut -c 1)
TWO=$( echo "$FILE_UUID" | cut -c 2)
THREE=$( echo "$FILE_UUID" | cut -c 3)

# create destination path and install cleanup hook
DEST_PATH=${FORM_ROOT}/${ONE}/${TWO}/${THREE}/${FILE_UUID}
echo "Creating $DEST_PATH"
mkdir -p ${DEST_PATH}

function finish {
  RV=$?
  if [ "$RV" -ne "0" ]; then
    echo "Deleting $DEST_PATH"
    rm -rf "$DEST_PATH"
  fi
  exit $RV
}
trap finish INT TERM EXIT

# read form html
ORIGINAL_FILE=${DEST_PATH}/${FILE_UUID}.${FILE_EXT}
echo "stdin to $ORIGINAL_FILE"
cat > $ORIGINAL_FILE || exit 2000


if [ "$SERVERNAME" == "localhost" ]; then
  ln -fs $DEST_PATH/* ${FORM_ROOT}/
fi

# success
echo "OK ${ORIGINAL_FILE}"
exit 0
