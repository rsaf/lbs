#!/bin/bash

# generate the directory names from UUID
ONE=$( echo "$FILE_UUID" | cut -c 1)
TWO=$( echo "$FILE_UUID" | cut -c 2)
THREE=$( echo "$FILE_UUID" | cut -c 3)

# create destination path and install cleanup hook
DEST_PATH=${QRCODE_ROOT}/${ONE}/${TWO}/${THREE}/${FILE_UUID}
echo "Creating $DEST_PATH"
mkdir -p ${DEST_PATH}

function finish {
  RV=$?
  if [ "$RV" -ne "0" ]; then
    echo "Deleting $DEST_PATH"
    rm -rf "$DEST_PATH"
  fi
  exit $RV
}
trap finish INT TERM EXIT

QR_INFORMATION=$OPTIONS
TEMP_FILE=${DEST_PATH}/${FILE_UUID}_temp.${FILE_EXT}
FINAL_FILE=${DEST_PATH}/${FILE_UUID}.${FILE_EXT}
$QRENCODE $QR_INFORMATION -o $TEMP_FILE
$COMPOSITE -gravity center $LOGO $TEMP_FILE $FINAL_FILE

if [ "$SERVERNAME" == "localhost" ]; then
  ln -fs $FINAL_FILE ${QRCODE_ROOT}/
fi

# success
echo "OK ${FINAL_FILE}"
exit 0
