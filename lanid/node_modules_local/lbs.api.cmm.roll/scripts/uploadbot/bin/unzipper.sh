

getPathFromUuid $FILE_ROOT $FILE_UUID

TMPDIR=`mktemp -d unzipper.XXXXXX`

mkdir -p $TMPDIR || exit 10
cd $TMPDIR

unzip $UUID_PATH/$FILE_UUID.zip || exit 20

NAME_TO_UUID=""

for filename in `ls *`
do
  EXTENSION="${filename##*.}"
  FILENAME="${filename%.*}"

  # setting RANDOM is setting the seed
  # with the same input (zip file input and file) the UUID output will be the same
  SEED=`echo ${filename}${FILE_UUID} | $MD5SUM`
  NUMBERSEED="${SEED//[!0-9]/}"
  SHORTSEED=`echo $NUMBERSEED | cut -b 1-19`
  CREATED_UUID=`uuid $SHORTSEED`
  echo "NUMBERSEED=$NUMBERSEED, SHORTSEED=$SHORTSEED, UUID=$CREATED_UUID"
  if [ "$EXTENSION" = "xlsx" ]; then
      getBucketNameFromUuid $CREATED_UUID
      cat $filename | ssh -i ~/.ssh/script $BUCKET_NAME "uploadfile $CREATED_UUID xlsx" || exit 30
      echo "XLSX=$CREATED_UUID"
      XLSXFILENAME=$filename
  else
    MIME_TYPE=`file -b --mime-type $filename`
    if [ "$MIME_TYPE" = "image/jpeg" ]; then
      getBucketNameFromUuid $CREATED_UUID
      cat $filename | ssh -i ~/.ssh/script $BUCKET_NAME "uploadphoto $CREATED_UUID jpg" || exit 40
      echo "[MAP]$FILENAME=$CREATED_UUID"
    fi
  fi
done

FILESIZE=`stat -f %z $XLSXFILENAME`
echo "DATA XLSX START $FILESIZE"
cat $XLSXFILENAME
echo "DATA XLSX END"