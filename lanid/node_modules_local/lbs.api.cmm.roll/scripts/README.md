# Image File Server

## Overview

* unique universal identifier random generation
 * every image uniquely identified
* structured hierarchy
* directly servable from nginx

see DESIGN.md

## Mac OS X local testing setup

Allow for local testing of the image processing setup.

### pre-requisites

* homebrew installed: http://brew.sh/
* brew install imagemagick
* brew install ghostscript (for fonts used in watermarks)
 
### creating user

Create local user uploadbot using Preferences > Users & Group panel

Allow remote login using Sharing > Remote Login > Allow access for

### setting up ssh access

Create a separate key within your regular user account

```
ssh-keygen -f ~/.ssh/uploadbot
```

Setup your uploadbot .ssh directory:

```
sudo su - uploadbot
mkdir ~uploadbot/.ssh
chmod 700 ~uploadbot/.ssh
```

Allow SSH passwordless access using your own key

```
$ sudo cp ~rngadam/.ssh/uploadbot.pub ~uploadbot/.ssh/authorized_keys
$ sudo chown uploadbot:staff ~uploadbot/.ssh/authorized_keys
$ sudo chmod 600 ~uploadbot/.ssh/authorized_keys
```

Test it:

```
$ ssh  uploadbot@localhost
Last login: Sat Dec 27 20:32:58 2014 from localhost
$ whoami
uploadbot
```

### installing scripts in uploadbot

```
$ sudo su - uploadbot
$ mkdir ~/bin   
$ ln -s ~rngadam/tchuta/pmm-prototype/uploadbot/*.sh ~/bin/
```

(receive path by your own local home/username/directory path)


edit ~uploadbot/.ssh/authorized_keys and prefix the key with:

```
command="~/bin/process_image_upload.sh" ssh-rsa [...]
```

### manually testing upload script

```
$ cat test/lenna.jpg | ssh uploadbot@localhost  "uploadimage dc9fa61e-873b-40f2-8ff5-f4257d00cb51"
dc9fa61e-873b-40f2-8ff5-f4257d00cb51
Creating /Users/uploadbot/sites/photos.localhost.static/d/c/9/dc9fa61e-873b-40f2-8ff5-f4257d00cb51
stdin to /Users/uploadbot/sites/photos.localhost.static/d/c/9/dc9fa61e-873b-40f2-8ff5-f4257d00cb51/dc9fa61e-873b-40f2-8ff5-f4257d00cb51.jpg
OK /Users/uploadbot/sites/photos.localhost.static/d/c/9/dc9fa61e-873b-40f2-8ff5-f4257d00cb51/dc9fa61e-873b-40f2-8ff5-f4257d00cb51.jpg
```

### manually testing watermark

```
curl "http://127.0.0.1:8080/watermark?file_uuid=131aea17-d1ab-4158-887b-a2a4ce2f7c47"
```

### Running and testing server 

Run server

```
node app.js
```

Upload form:

```
http://127.0.0.1:8080/
```

## test upload

Upload test file test/lenna.jpg:

```
curl --form upload=@test/lenna.jpg http://127.0.0.1:8080/upload
```

## TODO

* Split process_image_upload.sh into additional functionality parametrized
* Transformations
 * image resize
 * image watermarks
 * image print layout
* Create nginx vhost configuration (www) that can look up the proper bucket
* Create nginx vhost configuration (image server)
* Extract filesize and checksum information


* function(operation, imageData, uuid1, uuid2, uuid2DestinationHost) {
  
}

## more?

{
  operations: uploadonly, upload, watermark, printlayout,
  imageData: JPG data,
  uuid1: 
    when one parameter, destination
    when two parameters, source
  uuid2:
    destination
  uuid2DestinationHost: 
    where to do the upload to
}





