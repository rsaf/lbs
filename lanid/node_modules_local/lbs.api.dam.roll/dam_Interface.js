/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */



'use strict';
var mongoose = null ; //mongoose object
var message = null;   // message function

var Q = require('q');

function init(m) {
    var r = {pl: null , er:''};
    if(!(m.pl.fn instanceof Function)) {
        r.er = {ec:null , em: 'Payload pl is not a function'};
        return Q.fail(r);
    }

    message = m.pl.fn;
    // the promise for this init is completed once we get mongoose
    var p1 = message({
        op: 'dependency',
        pl: {dn:'mongoose'}
    });

return Q.all([p1]).then(function(r1){
        //console.log(r);
        mongoose = r1[0].pl.fn;
        console.log('\ndam: dam has received mongodb dependency: ' + mongoose.connection.name + ' with readyState: ' + mongoose.connection.readyState);
        var r = {pl: {pm: 'dam initialization done! '}, er: null};
        return Q(r);
    });

}



exports.operations = [init];

// re-export ops (for testing)
exports.operations.forEach(function(op) {
  exports[op.name] = op;
});
