/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

var database = require('mongodb').Db,
    connection = require('mongodb').Connection,
    server = require('mongodb').Server,
    async = require('async');
    
var host = process.env['MONGO_NODE_DRIVER_HOST'] != null ? process.env['MONGO_NODE_DRIVER_HOST'] : 'localhost';
var port = process.env['MONGO_NODE_DRIVER_PORT'] != null ? process.env['MONGO_NODE_DRIVER_PORT'] : connection.DEFAULT_PORT;

var db = new database('smsDatabase', 
                new server(host, port, 
                           { auto_reconnect: true,
                             poolSize: 20}),  { w: 1 });
 
exports.init = function(callback){
  
async.waterfall([

    // 1. open database connection
    function (cb) {
        console.log("\n** 1. opening db connection");
        db.open(cb);
    },

    // 2. create collections for users
    function (db, cb) {
        console.log("\n** 2. creating users collection if it does not exist.");
        db.collection("users", cb);
    },

    function (users_coll, cb) {
        exports.users = users_coll;
        console.log("\n** 3. creating acl collection if it does not exist");
        db.collection("acl", cb);
    },

    // 3. create collections for acls
    function (acl_coll, cb) {    
        exports.acl  = acl_coll;
       cb(null);
        }
    ], function (paramError, paramResults){
       if(!paramError){
        callback(null, paramResults);
       }
       else {
           callback(paramError);
       }
       
    });
};

exports.users = null;
exports.acl = null;
