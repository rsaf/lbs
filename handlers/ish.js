/** * Created by rollandsafort on 4/14/15. */var oHelpers = require('../utilities/helpers.js');var q = require('q');//details/search/...module.exports = function(paramService, esbMessage){    var searchRouter = paramService.Router();    searchRouter.get('/all.json', function(paramRequest, paramResponse){        //console.log(' search all detail pages---');        var m1 = {            "ns":"upm",            "op": "readAllCorporateDetailPageByID",            "pl":{pageSize:10            }        };        var m2 = {            "ns":"smm",            "op": "smm_readAllServicePointDetails",            "pl":{                pageSize:10            }        };        var m3 = {            "ns":"bmm",            "op": "bmm_readAllActivityDetails",            "pl":{pageSize:10            }        };        var p1 = esbMessage(m1);        var p2 = esbMessage(m2);        var p3 = esbMessage(m3);        q.all([p1,p2,p3])                .then(function(r) {                var mergedJson = r[0].pl.concat(r[1].pl,r[2].pl);                    oHelpers.sendResponse(paramResponse,200,mergedJson);                })                .fail(function(r) {                    console.log(r.er);                    var r = {pl:null, er:{ec:404,em:"could not find searched element"}};                    oHelpers.sendResponse(paramResponse,404,r);                });    });    searchRouter.get('/corporateDetails/:profileID.json', function(paramRequest, paramResponse){        //console.log('uph read corporate detail---');        var m = {            "ns":"upm",            "op": "readCorporateDetailPageByID",            "pl":{                cdc:paramRequest.params.profileID            }        };        esbMessage(m)            .then(function(r) {                //console.log(r.pl);                oHelpers.sendResponse(paramResponse,200,r);            })            .fail(function(r) {                console.log('ish error',r.er);                var r = {pl:null, er:{ec:404,em:"could not find detail page"}};                oHelpers.sendResponse(paramResponse,404,r);            });    });    searchRouter.get('/servicepointDetails/:servicepointCode.json', function(paramRequest, paramResponse, paramNext){        var m = {            "ns":"smm",            "op": "smm_readServicePointDetails",            "pl": {sprc:paramRequest.params.servicepointCode}        };        esbMessage(m)            .then(function(r) {                paramResponse.writeHead(200, {"Content-Type": "application/json"});                paramResponse.end(JSON.stringify(r));            })            .fail(function(r) {                paramResponse.writeHead(501, {"Content-Type": "application/json"});                if(r.er && r.er.ec && r.er.ec>1000){                    r.er.em='Server poblem....';                }                paramResponse.end(JSON.stringify(r));            });    });    return searchRouter;}