/** * Created by rollandsafort on 4/14/15. */var oHelpers = require('../utilities/helpers.js');var q = require('q');//details/search/...module.exports = function(paramService, esbMessage){    var searchRouter = paramService.Router();    searchRouter.get('/multiple.json', function(paramRequest, paramResponse){        var seachKey = paramRequest.query.key;        var scope = paramRequest.query.scope;        var p = null;        console.log('paramRequest.query----', paramRequest.query);        var m1 = {            "ns":"upm",            "op": "upm_getCorporateDetailPages",            "pl":{                  filter: seachKey            }        };        var m2 = {            "ns":"smm",            "op": "smm_readAllServicePointDetails",            "pl":{filter: seachKey            }        };        var m3 = {            "ns":"bmm",            "op": "bmm_readAllActivityDetails",            "pl":{                filter: seachKey            }        };        var p1 = esbMessage(m1);        var p2 = esbMessage(m2);        var p3 = esbMessage(m3);        if(scope === 'corporate'){            p = p1        }        if(scope === 'servicepoint'){            p = p2        }        if(scope === 'activity'){            p = p3        }        if(p){           p.then(function(r) {                    oHelpers.sendResponse(paramResponse,200,r);                })                .fail(function(r) {                    console.log(r.er);                    var r = {pl:null, er:{ec:404,em:"could not find searched element"}};                    oHelpers.sendResponse(paramResponse,404,r);                });        }        else{            q.all([p1,p2,p3])                .then(function(r) {                    //Zip-Concat                    var mtPage = paramRequest.query ? paramRequest.query.p : undefined;                    var mtPSize = paramRequest.query ? paramRequest.query.ps : undefined;                    var maxLength = r[0].pl.length + r[1].pl.length + r[2].pl.length;                    if(mtPage != undefined && mtPSize != undefined)                        maxLength = (mtPage + 1 ) * mtPSize;                    var zipconcat = [];                    var searchTargets = r.length;//NUMBER OF QUERY SETS WE'RE ZIPPING                    for(var i = 0; i < maxLength; i++)                    {                        for(var z = 0; z < searchTargets; z++)                        {                            if(i < r[z].pl.length)                            {                                zipconcat.push(r[z].pl[i])                            }                        }                    }                    if(mtPage != undefined && mtPSize != undefined)                    {                        zipconcat = zipconcat.slice(mtPage * mtPSize,(mtPage + 1) * mtPSize);                    }                    var mergedJson = {er: null, pl: null, mt: {p:null,ps:null,tc:null}};                    mergedJson.pl  = zipconcat;//r[0].pl.concat(r[1].pl,r[2].pl);                    mergedJson.mt = paramRequest.query                    mergedJson.mt.tc = r[0].mt.tc + r[1].mt.tc+r[2].mt.tc;                    console.log('corporate + servicepoint + activity----',r[0].mt.tc, '+',  r[1].mt.tc, '+',r[2].mt.tc);                    console.log('mergedJson.mt----',mergedJson.mt,paramRequest.query);                    oHelpers.sendResponse(paramResponse,200,mergedJson);                })                .fail(function(r) {                    console.log(r.er);                    var r = {pl:null, er:{ec:404,em:"could not find searched element"}};                    oHelpers.sendResponse(paramResponse,404,r);                });        }    });    searchRouter.get('/corporateDetails/:profileID.json', function(paramRequest, paramResponse){        //console.log('uph read corporate detail---');        var m = {            "ns":"upm",            "op": "readCorporateDetailPageByID",            "pl":{                cdc:paramRequest.params.profileID            }        };        if(paramRequest.user){            m.pl.uID = paramRequest.user.lanzheng.loginName;            m.pl.oID = paramRequest.user.currentOrganization;        }        esbMessage(m)            .then(function(r) {                //console.log(r.pl);                oHelpers.sendResponse(paramResponse,200,r);            })            .fail(function(r) {                console.log('ish error',r.er);                var r = {pl:null, er:{ec:404,em:"could not find detail page"}};                oHelpers.sendResponse(paramResponse,404,r);            });    });    searchRouter.get('/servicepointDetails/:servicepointCode.json', function(paramRequest, paramResponse, paramNext){        var m = {            "ns":"smm",            "op": "smm_readServicePointDetails",            "pl": {sprc:paramRequest.params.servicepointCode}        };        if(paramRequest.user){            m.pl.uID = paramRequest.user.lanzheng.loginName;            m.pl.oID = paramRequest.user.currentOrganization;        }        esbMessage(m)            .then(function(r) {                //paramResponse.writeHead(200, {"Content-Type": "application/json"});                //paramResponse.end(JSON.stringify(r));                oHelpers.sendResponse(paramResponse,200,r);            })            .fail(function(r) {                //paramResponse.writeHead(501, {"Content-Type": "application/json"});                if(r.er && r.er.ec && r.er.ec>1000){                    r.er.em='Server poblem....';                }                //paramResponse.end(JSON.stringify(r));                oHelpers.sendResponse(paramResponse,501,r);            });    });    return searchRouter;}